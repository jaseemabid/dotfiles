#!/usr/bin/env bash
# shellcheck disable=SC2016

set -euo pipefail

# Finds TODO, FIXME, BUG, etc in source code using ripgrep + fzf
#
# Format:
#   TODO: description
#   TODO(jabid): assigned to jabid
#   TODO(P1): high priority
#   FIXME(jabid,P1): assignee + priority
#
# Usage:
#   todo                    # find all tasks
#   todo --type py          # Python files only (ripgrep option)
#   todo | grep jabid       # Filter results

# Pattern matches common task markers
# Matches: TODO: or TODO(params):
PATTERN='(TODO|FIXME|BUG|HACK|NOTE|\?\?\?|XXX|IDEA)(\([^)]*\))?:'

# Search for task markers using ripgrep
# If stdout is a terminal, use fzf interactively
# Otherwise, just print the results (for piping/redirecting)

if [[ -t 1 ]]; then
  # Interactive mode: pipe to fzf
  rg --color=always --line-number --no-heading --smart-case "$PATTERN" "$@" |
    fzf --ansi \
        --color "hl:-1:underline,hl+:-1:underline:reverse" \
        --delimiter : --reverse \
        --preview 'bat --color=always {1} --highlight-line {2} --terminal-width $FZF_PREVIEW_COLUMNS' \
        --preview-window 'right,60%,border-left,+{2}+3/3,~6' \
        --tmux 'center,95%,50%' \
        --bind 'enter:become(code --reuse-window -g {1}:{2})'
else
  # Non-interactive mode: just print results
  rg --color=always --line-number --no-heading --smart-case "$PATTERN" "$@"
fi
